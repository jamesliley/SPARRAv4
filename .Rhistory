# 9x9 on each page
shap9=c()
ind=1
for (i in 1:floor(length(shap_names)/9)) {
sub=paste0(
"\\begin{figure}[b]\n",
shap3[ind],"\n",shap3[ind+1],"\n",shap3[ind+2],"\n",
"\\caption{Influence profile on risk scores by variable and value, ",
"in decreasing order of mean absolute Shapley value. Vertical lines ",
"show standard deviations. Y axes are identical in all plots. Data ",
"are anonymised to have $>10$ individuals for each x axis mark, so ",
"some X axis spacings are irregular. Plots are not shown if data are ",
"not sufficiently anonymous }\n",
"\label{supp_fig:shapley_all",i,"}\n",
"\\end{figure}\n"
)
ind=ind+3
shap9=c(shap9,sub)
}
subx=paste0("\\begin{figure}[b]\n")
for (j in ind:(length(shap3))) subx=paste0(subx,shap3[j],"\n")
subx=paste0(subx,    "\\caption{Influence profile on risk scores by variable and value, ",
"in decreasing order of mean absolute Shapley value. Vertical lines ",
"show standard deviations. Y axes are identical in all plots. Data ",
"are anonymised to have $>10$ individuals for each x axis mark, so ",
"some X axis spacings are irregular. Plots are not shown if data are ",
"not sufficiently anonymous }\n",
"\label{supp_fig:shapley_all",ceiling(length(shap_names)/9),"}\n",
"\\end{figure}\n"
)
shap9=c(shap9,subx)
shap_all=paste(shap9,collapse="\n\n")
cat(shap_all)
source("~/Research/SPARRA/git/SPARRAv4/Analysis/external/shap_latex.R")
source("~/Research/SPARRA/git/SPARRAv4/Analysis/external/shap_latex.R")
source("~/Research/SPARRA/git/SPARRAv4/Analysis/external/shap_latex.R")
source("~/Research/SPARRA/git/SPARRAv4/Analysis/external/shap_latex.R")
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf"),full.names=TRUE)
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
i=7
shap_names[i]
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1
w
r1s=r1[(w+1):length(r1)]
r1s
r1s=paste0(r1[(w+1):length(r1)], collapse="; ")
r1s
shap_names[3]
basename(shap_names[1:4])
grep("small",basename(shap_names[1:4]))
grepl("small",basename(shap_names[1:4]))
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="; ")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
r1s
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
varname
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=lab,las=2)
abline(h=0,lty=2)
source("~/Research/SPARRA/git/SPARRAv4/Analysis/external/shap_latex.R")
signif(0,digits=3)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=signif(x0,digits=3),las=2)
abline(h=0,lty=2)
shap_names[1:20]
i=18
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
r1s
install.packages("pdftools")
install.packages("pdftools")
library(pdftoo)ls
library(pdftools)
pdf1=shap_names[1]
pdf1
pdf1=paste0(shap_names[1].pdf)
pdf1=paste0(shap_names[1],".pdf")
p1=pdf_text(pdf1)
class(p1)
p1
cat(p1)
apply(p1,nchar)
nchar(p1)
p2=unlist(strsplit(p1,"\n"))
p2
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]
p2
nchar(p2)
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=p2[which(nchar(p2)<15)]
p2
trimws(p2)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(shap_names[i],".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=p2[which(nchar(p2)<15)]
xlabs=trimws(p2)
labs[[i]]=xlabs
names(labs)[length(labs)]=shap_names[i]
}
labs[15]
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(shap_names[i],".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=p2[which(nchar(p2)<15)]
xlabs=trimws(p2)
labs[[i]]=xlabs
names(labs)[length(labs)]=basename(shap_names[i])
}
labs[[15]]
### Fix Shapley value plots: currently no title
## Run this from the directory containing subfolder 'Analysis'
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
source("SPARRAv4/auxiliary.R")
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(shap_names[i],".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=p2[which(nchar(p2)<15)]
xlabs=trimws(p2)
labs[[i]]=xlabs
names(labs)[length(labs)]=basename(shap_names[i])
}
for (i in 1:length(shap_names)) {
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
pdf(paste0(shap_names[i],".pdf"),width=7,height=6)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=labs[[i]],las=2)
abline(h=0,lty=2)
dev.off()
}
library(dplyr)
sink()
dev.ofF()
dev.off()
dev.off()
### Fix Shapley value plots: currently no title
## Run this from the directory containing subfolder 'Analysis'
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
library(dplyr)
source("SPARRAv4/auxiliary.R")
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=p2[which(nchar(p2)<15)]
xlabs=trimws(p2)
labs[[i]]=xlabs
names(labs)[length(labs)]=basename(shap_names[i])
}
for (i in 1:length(shap_names)) {
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
pdf(paste0(shap_names[i],".pdf"),width=7,height=6)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=labs[[i]],las=2)
abline(h=0,lty=2)
dev.off()
}
i
labs[[i]]
names(labs)[[i]]
i=15
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=p2[which(nchar(p2)<15)]
p2
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=grep(p2,"[0-9- ]{1,}",val=TRUE)
p2
help(grep)
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
grep("[0-9- ]{1,}",p2,val=TRUE)
grep("[0-9\- ]{1,}",p2,val=TRUE)
i
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))]; p2=trimws(gsub("●","",p2))
p2=p2[which(nchar(p2)<15)]
p2
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
p2=p2[which(nchar(p2)<15)]
p2
dev.ofF()
dev.off()
dev.off()
### Fix Shapley value plots: currently no title
## Run this from the directory containing subfolder 'Analysis'
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
library(dplyr)
source("SPARRAv4/auxiliary.R")
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
p2=p2[which(nchar(p2)<15)]
xlabs=trimws(p2)
labs[[i]]=xlabs
names(labs)[length(labs)]=basename(shap_names[i])
}
for (i in 1:length(shap_names)) {
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
pdf(paste0(shap_names[i],".pdf"),width=7,height=6)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=labs[[i]],las=2)
abline(h=0,lty=2)
dev.off()
}
i
labs[[i]]
### Fix Shapley value plots: currently no title
## Run this from the directory containing subfolder 'Analysis'
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
library(dplyr)
source("SPARRAv4/auxiliary.R")
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
if ("Yes" %in% p2) p2=c("No","Yes") else p2=p2[which(nchar(p2)<15)]
labs[[i]]=p2
names(labs)[length(labs)]=basename(shap_names[i])
}
for (i in 1:length(shap_names)) {
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
pdf(paste0(shap_names[i],".pdf"),width=7,height=6)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=labs[[i]],las=2)
abline(h=0,lty=2)
dev.off()
}
i
labs[[29]]
names(labs)[29]
i=29
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2
p2=trimws(gsub("●","",p2));
p2
shap_names[1:20]
i=1
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2
dev.ofF()
dev.off()
dev.off()
dev.off()
### Fix Shapley value plots: currently no title
## Run this from the directory containing subfolder 'Analysis'
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
library(dplyr)
source("SPARRAv4/auxiliary.R")
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
if (grepl("small",basename(shap_names[i])))
yv=c("0.06","0.04","0.02","0.00","−0.02") else
yv=c("0.00","0.05","0.10","0.15")
p2=setdiff(p2,yv)
if ("Yes" %in% p2) p2=c("No","Yes") else p2=p2[which(nchar(p2)<15)]
labs[[i]]=p2
names(labs)[length(labs)]=basename(shap_names[i])
}
for (i in 1:length(shap_names)) {
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
pdf(paste0(shap_names[i],".pdf"),width=7,height=6)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=labs[[i]],las=2)
abline(h=0,lty=2)
dev.off()
}
i
labs[[i]]
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2
shap_var=gsub("shapley_","",basename(shap_names))
shap_var[1:5]
library(dplyr)
source("SPARRAv4/auxiliary.R")
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All_old/",pattern="*.pdf",full.names=TRUE))
shap_var=gsub("_large_range","",gsub("_small_range","",gsub("shapley_","",basename(shap_names))))
sub=which(is.na(longvarnames(shap_var)))
sub
shap_var[sub]
### Fix Shapley value plots: currently no title
## Run this from the directory containing subfolder 'Analysis'
library(dplyr)
source("SPARRAv4/auxiliary.R")
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All_old/",pattern="*.pdf",full.names=TRUE))
shap_var=gsub("_large_range","",gsub("_small_range","",gsub("shapley_","",basename(shap_names))))
sub=which(!is.na(longvarnames(shap_var)))
shap_names=shap_names[sub]
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
if (grepl("small",basename(shap_names[i])))
yv=c("0.06","0.04","0.02","0.00","−0.02") else
yv=c("0.00","0.05","0.10","0.15")
p2=setdiff(p2,yv)
if ("Yes" %in% p2) p2=c("No","Yes") else p2=p2[which(nchar(p2)<15)]
labs[[i]]=p2
names(labs)[length(labs)]=basename(shap_names[i])
}
for (i in 1:length(shap_names)) {
r1=readLines(paste0(shap_names[i],".txt"))
w=which(r1=="***************")
r1s=paste0(r1[(w+1):length(r1)], collapse="\n")
eval(parse(text=r1s))
if (grepl("small",basename(shap_names[i]))) yvar=small_range else yvar=large_range
varname=gsub("_small_range","",
gsub("_large_range","",
gsub("shapley_","",basename(shap_names[i]))))
pdf(paste0(shap_names[i],".pdf"),width=7,height=6)
par(mar=c(7,4.1,4.1,2.1))
plot(0,type="n",xlim=range(x0),ylim=yvar,main=longvarnames(varname),xaxt="n",
xlab="",ylab="Shapley value") # note fixed ylim
lines(x0,mx,lty=2,col="red")
segments(x0,mx-sdx,x0,mx+sdx,col="red")
points(x0,mx,pch=16,col="red")
axis(1,at=x0,labels=labs[[i]],las=2)
abline(h=0,lty=2)
dev.off()
# Copy over .txt
}
i
labs
shap_names=gsub(".pdf","",list.files("Analysis/full_model/Shapley_values/All/",pattern="*.pdf",full.names=TRUE))
shap_var=gsub("_large_range","",gsub("_small_range","",gsub("shapley_","",basename(shap_names))))
sub=which(!is.na(longvarnames(shap_var)))
shap_names=shap_names[sub]
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
if (grepl("small",basename(shap_names[i])))
yv=c("0.06","0.04","0.02","0.00","−0.02") else
yv=c("0.00","0.05","0.10","0.15")
p2=setdiff(p2,yv)
if ("Yes" %in% p2) p2=c("No","Yes") else p2=p2[which(nchar(p2)<15)]
labs[[i]]=p2
names(labs)[length(labs)]=basename(shap_names[i])
}
i
old_dir="Analysis/full_model/Shapley_values/All_old/"
new_dir="Analysis/full_model/Shapley_values/All/"
shap_names=paste0(new_dir,gsub(".pdf","",list.files(old_dir,pattern="*.pdf",full.names=FALSE)))
shap_var=gsub("_large_range","",gsub("_small_range","",gsub("shapley_","",basename(shap_names))))
sub=which(!is.na(longvarnames(shap_var)))
shap_names=shap_names[sub]
large_range=c(-0.015,0.15)
small_range=c(-0.022,0.065)
shap_names
# Get labels, because I forgot to do this
library(pdftools)
labs=list()
for (i in 1:length(shap_names)) {
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
if (grepl("small",basename(shap_names[i])))
yv=c("0.06","0.04","0.02","0.00","−0.02") else
yv=c("0.00","0.05","0.10","0.15")
p2=setdiff(p2,yv)
if ("Yes" %in% p2) p2=c("No","Yes") else p2=p2[which(nchar(p2)<15)]
labs[[i]]=p2
names(labs)[length(labs)]=basename(shap_names[i])
}
i
p1
i
paste0(gsub("All","All_old",shap_names[i]),".pdf")
x1=paste0(gsub("All","All_old",shap_names[i]),".pdf")
file.exists(x1)
p1=pdf_text(paste0(gsub("All","All_old",shap_names[i]),".pdf"))
p2=unlist(strsplit(p1,"\n")); p2=p2[which(!(p2==""))];
p2=trimws(gsub("●","",p2)); p2=setdiff(p2,c("","Shapley value"))
q()
